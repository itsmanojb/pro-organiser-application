/* eslint-disable no-unused-vars */
import React, { useState, useContext, useEffect } from 'react';
import { getProject, updateProject } from 'utils/data';
import { ToastsContext } from 'context/Toasts';
import Icon from 'components/misc/IonIcon';

import '../create-new/AddNew.scss';
import { ProjectContext } from 'context/Project';

export const EditProject = ({ project, added, closed }) => {

  const [name, setName] = useState('');
  const [teamMembers, setTeamMembers] = useState([]);
  const [newMembers, setNewMembers] = useState('');
  const [description, setDescription] = useState('');
  const [formSubmitted, setFormSubmitted] = useState(false);
  const [toasts, setToasts] = useContext(ToastsContext);
  const [currentProject, setCurrentProject] = useContext(ProjectContext);

  useEffect(() => {
    setName(project.name);
    setDescription(project.description);
    setTeamMembers(project.members);
  }, [project]);

  const saveProject = () => {
    if (!name) {
      showError('Project name cannot be left blank');
      return;
    }

    const members = newMembers.split(',').map((el) => el.trim());
    const editedProject = {
      name,
      members: [...members, ...teamMembers],
      description
    };
    setFormSubmitted(true);
    updateProject(project.id, editedProject).then(async (updated) => {
      if (updated) {
        if (updated) {
          const updatedDoc = await getProject(project.id);
          updatedDoc['id'] = project.id;
          setCurrentProject(updatedDoc);
        }
        added(new Date().getTime());
        setToasts([
          ...toasts,
          {
            message: 'Project has been updated',
            id: toasts.length,
            title: 'Success',
            backgroundColor: '#47bf50',
            icon: 'checkmark-circle'
          }
        ]);
      } else {
        showError('Failed to update project details');
        return;
      }
    })
      .catch(() => {
        showError('Could not update project. Some error occured.');
        return;
      });
  };

  const goBack = () => {
    closed();
  }

  const showError = (message) => {
    setFormSubmitted(false);
    setToasts([
      ...toasts,
      {
        message,
        id: toasts.length,
        title: 'Error',
        backgroundColor: '#d9534f',
        icon: 'warning'
      }
    ]);
  }

  return (
    <main className="content">
      <div className="modal-page-ui new-board">
        <button className="close" onClick={() => goBack()}>
          <Icon name="close" />
        </button>
        <div className="modal-page-content">
          <h2>Edit project details</h2>
          <div className="floating">
            <input
              type="text"
              name="name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              id="name"
              placeholder="Project name"
              className="floating__input"
              autoComplete="off"
            />
            <label htmlFor="name" className="floating__label" data-content="Project name *">
              <span className="hidden--visually">Project name</span>
            </label>
          </div>
          <div className="floating textarea">
            <textarea
              type="text"
              name="type"
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              id="type"
              placeholder="Project description"
              className="floating__input"
              autoComplete="off"
            />
            <label htmlFor="type" className="floating__label" data-content="Project description">
              <span className="hidden--visually">Project description</span>
            </label>
          </div>
          <div className="member-list">
            <span>Project Members</span>
            <div className="list">
              {teamMembers.map((m, i) => <span key={i}>{m}</span>)}
            </div>
          </div>
          <div className="floating">
            <input
              type="text"
              name="members"
              value={newMembers}
              onChange={(e) => setNewMembers(e.target.value)}
              id="members"
              placeholder="More members"
              className="floating__input"
              autoComplete="off"
            />
            <label htmlFor="members" className="floating__label" data-content="Add more members">
              <span className="hidden--visually">Add more members</span>
            </label>
          </div>
          <div className="help-block">
            Use comma (,) as separator
        </div>
          <div className="form-buttons">
            <button type="submit" onClick={saveProject} disabled={formSubmitted} id="EditProject" className="button">
              {formSubmitted ? 'Submitting...' : 'Submit'}
            </button>
          </div>
        </div>
      </div>
    </main>
  );
};
